# handlers/isee_handler.py
# Ù…Ø­Ø§Ø³Ø¨Ù‡ ISEE â€“ Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
# Ù…Ø±Ø­Ù„Ù‡ Û± Ø§Ø² Û´ â€“ Ù¾Ø§ÛŒÙ‡ØŒ Ù†Ø±Ø® Ø§Ø±Ø² Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒØŒ Ø§Ø³ØªÙ¾ Ø´Ø±ÙˆØ¹
# Ø¯Ø³Ø§Ù…Ø¨Ø± 2025

from aiogram import Router, types, F
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

from config import settings, logger
from datetime import datetime
import httpx

router = Router()

# ------------------------------------------------------------------
# Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø¬Ø§Ø±ÛŒ + ØªØ§Ø±ÛŒØ®Ú†Ù‡)
# ------------------------------------------------------------------
user_data = {}  
# Ø³Ø§Ø®ØªØ§Ø±:
# {
#   user_id: {
#       "current": {...},
#       "history": [{"isee": 23000, "date": "..."}]
#   }
# }

# ------------------------------------------------------------------
# State Ù‡Ø§
# ------------------------------------------------------------------
class ISEEState(StatesGroup):
    intro = State()              # Ù…Ø±Ø­Ù„Ù‡ Ù…Ø¹Ø±ÙÛŒ (Ø§Ø³ØªÙ¾ Ø´Ø±ÙˆØ¹)
    waiting_income = State()
    waiting_members = State()
    waiting_property = State()
    waiting_financial = State()
    waiting_abroad = State()

# ------------------------------------------------------------------
# Ø¢Ø³ØªØ§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø³Ù…ÛŒ DSU (2025â€“2026)
# ------------------------------------------------------------------
ISEE_LIMITS = {
    "full": 26000,      # Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ú©Ø§Ù…Ù„ + Ø®ÙˆØ§Ø¨Ú¯Ø§Ù‡
    "partial": 38000,   # Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ø¬Ø²Ø¦ÛŒ
    "low": 50000        # Ú©Ù…Ú© Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù…
}

AVERAGE_ISEE_IRANIAN = 22800  # Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ÙˆØ§Ù‚Ø¹ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ù¾Ø±ÙˆØ¬Ø§

# ------------------------------------------------------------------
# API KEYS Ù†ÙˆØ³Ø§Ù† (Ú†Ø±Ø®Ø´ÛŒ â€“ Ù¾Ø§ÛŒØ¯Ø§Ø± Ùˆ Ø§Ù…Ù†)
# ------------------------------------------------------------------
NAVASAN_API_KEYS = [
    "freepnP0B5PJNRJD5XUTFauKTpubrxE2",
    "freeWVcwTB4Xq8yT48Y0YHgCy8JcvulU",
    "freezW677iqPcZxRFwQbpX0iZQfxaWwi",
    "freeb2n6GMnQA0IIxbKUX3y9BC51Cn2N",
    "freeZjQukbJZKuek0fWGgww8C8bf2wG4",
]

_current_key_index = 0

# ------------------------------------------------------------------
# Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø±Ø² Ø§Ø² NAVASAN (ÙˆØ§Ù‚Ø¹ÛŒØŒ Ø¨Ø¯ÙˆÙ† Ú©Ø´)
# ------------------------------------------------------------------
async def get_rates_from_navasan():
    """
    Ù†Ø±Ø® Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ ÛŒÙˆØ±Ùˆ Ùˆ Ø¯Ù„Ø§Ø± Ø¨Ø§Ø²Ø§Ø± Ø¢Ø²Ø§Ø¯
    Ù…Ù†Ø¨Ø¹: navasan.net
    """
    global _current_key_index

    for _ in range(len(NAVASAN_API_KEYS)):
        api_key = NAVASAN_API_KEYS[_current_key_index]
        _current_key_index = (_current_key_index + 1) % len(NAVASAN_API_KEYS)

        try:
            async with httpx.AsyncClient(timeout=15.0) as client:
                resp = await client.get(
                    "https://api.navasan.tech/latest/",
                    params={"api_key": api_key}
                )

            if resp.status_code != 200:
                continue

            data = resp.json()

            eur = data.get("eur", {}).get("value")
            usd = data.get("usd", {}).get("value")

            if eur and usd:
                eur_rate = int(float(eur))
                usd_rate = int(float(usd))

                logger.success(
                    f"NAVASAN OK | EUR={eur_rate:,} | USD={usd_rate:,}"
                )
                return eur_rate, usd_rate

        except Exception as e:
            logger.warning(f"NAVASAN key failed: {e}")
            continue

    # fallback Ø§Ù…Ù† (ÙÙ‚Ø· Ø§Ú¯Ø± Ù‡Ù…Ù‡ API Ù‡Ø§ Ù‚Ø·Ø¹ Ø´ÙˆÙ†Ø¯)
    logger.error("NAVASAN unavailable â€“ fallback used")
    return 65000, 60000


# ------------------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û° â€“ Ø´Ø±ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ ISEE (Ø§Ø³ØªÙ¾ Ù…Ø¹Ø±ÙÛŒ)
# ------------------------------------------------------------------
@router.callback_query(F.data == "isee")
async def isee_intro(callback: types.CallbackQuery, state: FSMContext):
    user_id = callback.from_user.id

    if user_id not in user_data:
        user_data[user_id] = {"history": []}

    user_data[user_id]["current"] = {}

    # Ù¾ÛŒØ§Ù… Ø§Ù†ØªØ¸Ø§Ø±
    wait_msg = await callback.message.edit_text(
        "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø±Ø® Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø±Ø² Ø§Ø² <b>navasan.net</b>...\n"
        "Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ğŸ’±",
        parse_mode="HTML"
    )

    eur_rate, usd_rate = await get_rates_from_navasan()

    user_data[user_id]["current"]["eur_rate"] = eur_rate
    user_data[user_id]["current"]["usd_rate"] = usd_rate

    text = (
        "ğŸ§® <b>Ù…Ø­Ø§Ø³Ø¨Ù‡ ISEE (Ø´Ø§Ø®Øµ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡)</b>\n\n"
        "ISEE Ø¹Ø¯Ø¯ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¯ÙˆÙ„Øª Ø§ÛŒØªØ§Ù„ÛŒØ§ Ø¨Ø±Ø§ÛŒ:\n"
        "â€¢ Ø¨ÙˆØ±Ø³ÛŒÙ‡ DSU\n"
        "â€¢ Ø®ÙˆØ§Ø¨Ú¯Ø§Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ\n"
        "â€¢ Ú©Ø§Ù‡Ø´ Ø´Ù‡Ø±ÛŒÙ‡\n"
        "Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.\n\n"
        "ğŸ“Œ Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± Ø¨Ù‡â€ŒØµÙˆØ±Øª <b>ØªØ®Ù…ÛŒÙ† Ø¨Ø³ÛŒØ§Ø± Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ ÙˆØ§Ù‚Ø¹ÛŒØª</b>\n"
        "Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø§ÛŒØ±Ø§Ù†ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.\n\n"
        "ğŸ’± <b>Ù†Ø±Ø® Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø¢Ø²Ø§Ø¯:</b>\n"
        f"â€¢ Û± â‚¬ = <b>{eur_rate:,}</b> ØªÙˆÙ…Ø§Ù†\n"
        f"â€¢ Û± $ = <b>{usd_rate:,}</b> ØªÙˆÙ…Ø§Ù†\n"
        f"ğŸ• {datetime.now().strftime('%H:%M - %d/%m/%Y')}\n\n"
        "âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¯Ù‚ÛŒÙ‚ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯Ø› Ù†ØªÛŒØ¬Ù‡ Ø±ÙˆÛŒ Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ø´Ù…Ø§ Ø§Ø«Ø± Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ø±Ø¯.\n\n"
        "<b>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ</b>"
    )

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="ğŸš€ Ø´Ø±ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ ISEE",
            callback_data="isee_start_form"
        )],
        [InlineKeyboardButton(
            text="ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ",
            callback_data="main_menu"
        )]
    ])

    await wait_msg.edit_text(text, reply_markup=keyboard, parse_mode="HTML")
    await state.set_state(ISEEState.intro)
    await callback.answer()
# ---------------------------------------------------------
# Ø´Ø±ÙˆØ¹ ÙØ±Ù… â€“ Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Ù…Ø¹Ø±ÙÛŒ
# ---------------------------------------------------------
@router.callback_query(F.data == "isee_start_form")
async def start_isee_form(callback: types.CallbackQuery, state: FSMContext):
    await callback.message.edit_text(
        "ğŸ“‹ <b>ÙØ±Ù… Ù…Ø­Ø§Ø³Ø¨Ù‡ ISEE</b>\n\n"
        "<b>Ù…Ø±Ø­Ù„Ù‡ Û±:</b>\n"
        "ğŸ’¶ Ø¯Ø±Ø¢Ù…Ø¯ Ø³Ø§Ù„Ø§Ù†Ù‡ Ú©Ù„ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ (Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ø§Ù„ÛŒØ§Øª) Ú†Ù†Ø¯ ÛŒÙˆØ±Ùˆ Ø§Ø³ØªØŸ\n\n"
        "<i>Ù…Ø«Ø§Ù„:</i>\n"
        "â€¢ 12000\n"
        "â€¢ 18500.50\n"
        "â€¢ Ø§Ú¯Ø± Ø¯Ø±Ø¢Ù…Ø¯ Ù†Ø¯Ø§Ø±ÛŒØ¯: 0",
        parse_mode="HTML"
    )
    await state.set_state(ISEEState.waiting_income)
    await callback.answer()

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û± â€“ Ø¯Ø±Ø¢Ù…Ø¯
# ---------------------------------------------------------
@router.message(ISEEState.waiting_income)
async def process_income(message: types.Message, state: FSMContext):
    user_id = message.from_user.id

    try:
        income = float(message.text.replace(",", "").strip())
        if income < 0:
            raise ValueError

        user_data[user_id]["current"]["income"] = income
        eur_rate = user_data[user_id]["current"]["eur_rate"]

        await message.reply(
            f"âœ… Ø¯Ø±Ø¢Ù…Ø¯ Ø«Ø¨Øª Ø´Ø¯:\n"
            f"<b>{income:,.2f} â‚¬</b>\n"
            f"â‰ˆ <b>{int(income * eur_rate):,} ØªÙˆÙ…Ø§Ù†</b>\n\n"
            "<b>Ù…Ø±Ø­Ù„Ù‡ Û²:</b>\n"
            "ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¶Ø§ÛŒ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ (Ø´Ø§Ù…Ù„ Ø®ÙˆØ¯ØªØ§Ù†) Ú†Ù†Ø¯ Ù†ÙØ± Ø§Ø³ØªØŸ\n\n"
            "<i>Ù…Ø«Ø§Ù„: 3 ÛŒØ§ 4</i>",
            parse_mode="HTML"
        )

        await state.set_state(ISEEState.waiting_members)

    except Exception:
        await message.reply(
            "âš ï¸ Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\n"
            "Ù…Ø«Ø§Ù„: 12000 ÛŒØ§ 15000.75"
        )

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û² â€“ Ø§Ø¹Ø¶Ø§ÛŒ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡
# ---------------------------------------------------------
@router.message(ISEEState.waiting_members)
async def process_members(message: types.Message, state: FSMContext):
    user_id = message.from_user.id

    try:
        members = int(message.text.strip())
        if members < 1 or members > 10:
            raise ValueError

        user_data[user_id]["current"]["members"] = members

        await message.reply(
            f"âœ… ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¶Ø§ÛŒ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡: <b>{members} Ù†ÙØ±</b>\n\n"
            "<b>Ù…Ø±Ø­Ù„Ù‡ Û³:</b>\n"
            "ğŸ  Ø§Ø±Ø²Ø´ Ú©Ù„ Ø§Ù…Ù„Ø§Ú© Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ø¯Ø± Ø§ÛŒØªØ§Ù„ÛŒØ§ Ú†Ù†Ø¯ ÛŒÙˆØ±Ùˆ Ø§Ø³ØªØŸ\n\n"
            "<i>Ø§Ú¯Ø± Ù…Ù„Ú©ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯: 0</i>",
            parse_mode="HTML"
        )

        await state.set_state(ISEEState.waiting_property)

    except Exception:
        await message.reply(
            "âš ï¸ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 2 ØªØ§ 6)"
        )

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û³ â€“ Ù…Ù„Ú©
# ---------------------------------------------------------
@router.message(ISEEState.waiting_property)
async def process_property(message: types.Message, state: FSMContext):
    user_id = message.from_user.id

    try:
        property_value = float(message.text.replace(",", "").strip())
        if property_value < 0:
            raise ValueError

        user_data[user_id]["current"]["property"] = property_value
        eur_rate = user_data[user_id]["current"]["eur_rate"]

        await message.reply(
            f"âœ… Ø§Ø±Ø²Ø´ Ù…Ù„Ú© Ø«Ø¨Øª Ø´Ø¯:\n"
            f"<b>{property_value:,.2f} â‚¬</b>\n"
            f"â‰ˆ <b>{int(property_value * eur_rate):,} ØªÙˆÙ…Ø§Ù†</b>\n\n"
            "â–¶ï¸ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ Ø§Ø³Øª.",
            parse_mode="HTML"
        )

        # Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø¹Ù…Ø¯Ø§Ù‹ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Û³ ÙØ§ÛŒÙ„ Ù…ÛŒâ€ŒØ¢ÛŒØ¯
        await state.set_state(ISEEState.waiting_financial)

    except Exception:
        await message.reply(
            "âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\n"
            "Ù…Ø«Ø§Ù„: 0 ÛŒØ§ 25000"
        )
# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û´ â€“ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù…Ø§Ù„ÛŒ Ø¯Ø§Ø®Ù„ Ø§ÛŒØªØ§Ù„ÛŒØ§
# ---------------------------------------------------------
@router.message(ISEEState.waiting_financial)
async def process_financial_assets(message: types.Message, state: FSMContext):
    user_id = message.from_user.id

    try:
        financial = float(message.text.replace(",", "").strip())
        if financial < 0:
            raise ValueError

        user_data[user_id]["current"]["financial"] = financial
        eur_rate = user_data[user_id]["current"]["eur_rate"]

        await message.reply(
            f"âœ… Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù…Ø§Ù„ÛŒ Ø«Ø¨Øª Ø´Ø¯:\n"
            f"<b>{financial:,.2f} â‚¬</b>\n"
            f"â‰ˆ <b>{int(financial * eur_rate):,} ØªÙˆÙ…Ø§Ù†</b>\n\n"
            "<b>Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯:</b>\n"
            "ğŸŒ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø§ÛŒØªØ§Ù„ÛŒØ§ Ø¯Ø§Ø±ÛŒØ¯ØŸ\n"
            "Ø§Ú¯Ø± Ù†Ø¯Ø§Ø±ÛŒØ¯ Ø¹Ø¯Ø¯ 0 Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.",
            parse_mode="HTML"
        )

        await state.set_state(ISEEState.waiting_foreign_assets)

    except Exception:
        await message.reply(
            "âš ï¸ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\n"
            "Ù…Ø«Ø§Ù„: 0 ÛŒØ§ 8500"
        )
# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Ûµ â€“ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø§ÛŒØªØ§Ù„ÛŒØ§ + Ù…Ø­Ø§Ø³Ø¨Ù‡ ISEE
# ---------------------------------------------------------
@router.message(ISEEState.waiting_foreign_assets)
async def process_foreign_assets_and_calculate(message: types.Message, state: FSMContext):
    user_id = message.from_user.id

    try:
        foreign_assets = float(message.text.replace(",", "").strip())
        if foreign_assets < 0:
            raise ValueError

        data = user_data[user_id]["current"]
        data["foreign_assets"] = foreign_assets

        income = data["income"]
        property_value = data["property"]
        financial = data["financial"]
        members = data["members"]
        eur_rate = data["eur_rate"]

        # -----------------------------
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ú©Ù„
        # -----------------------------
        total_assets = property_value + financial + foreign_assets

        # Ø·Ø¨Ù‚ ÙØ±Ù…ÙˆÙ„ Ø³Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡ ISEE
        iser = income + (0.20 * total_assets)

        # Ø¶Ø±ÛŒØ¨ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ (Scala di equivalenza)
        scale_map = {
            1: 1.00,
            2: 1.57,
            3: 2.04,
            4: 2.46,
            5: 2.85
        }
        scale = scale_map.get(members, 2.85 + (members - 5) * 0.35)

        isee = iser / scale

        # Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡
        data["isee"] = round(isee, 2)

        # -----------------------------
        # Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡
        # -----------------------------
        await message.reply(
            "ğŸ“Š <b>Ù†ØªÛŒØ¬Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ ISEE (ØªØ®Ù…ÛŒÙ†ÛŒ)</b>\n\n"
            f"ğŸ‘¥ Ø§Ø¹Ø¶Ø§ÛŒ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡: <b>{members}</b>\n"
            f"ğŸ’¶ Ø¯Ø±Ø¢Ù…Ø¯: <b>{income:,.2f} â‚¬</b>\n"
            f"ğŸ  Ù…Ù„Ú©: <b>{property_value:,.2f} â‚¬</b>\n"
            f"ğŸ’³ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù…Ø§Ù„ÛŒ: <b>{financial:,.2f} â‚¬</b>\n"
            f"ğŸŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø§ÛŒØªØ§Ù„ÛŒØ§: <b>{foreign_assets:,.2f} â‚¬</b>\n\n"
            f"ğŸ“ Ø¶Ø±ÛŒØ¨ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡: <b>{scale}</b>\n\n"
            f"âœ… <b>ISEE â‰ˆ {isee:,.2f} â‚¬</b>\n"
            f"â‰ˆ <b>{int(isee * eur_rate):,} ØªÙˆÙ…Ø§Ù†</b>\n\n"
            "â„¹ï¸ Ø§ÛŒÙ† Ø¹Ø¯Ø¯ ØªØ®Ù…ÛŒÙ†ÛŒ Ø§Ø³Øª Ùˆ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ùˆ Ù…Ø¹Ø§ÙÛŒØªâ€ŒÙ‡Ø§ Ù…ÙÛŒØ¯ Ø§Ø³Øª.",
            parse_mode="HTML"
        )

        await state.clear()

    except Exception:
        await message.reply(
            "âš ï¸ Ø¹Ø¯Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."
        )
# ------------------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û´ â€“ Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ø´Ø§Ù‡Ú©Ø§Ø± + ØªØ§Ø±ÛŒØ®Ú†Ù‡ + UX Ù†Ù‡Ø§ÛŒÛŒ
# ------------------------------------------------------------------
@router.message(ISEEState.waiting_abroad)
async def process_abroad_and_result(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    data = user_data[user_id]
    eur_rate = data["current"]["eur_rate"]
    
    # Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ±ÙˆØ¯ÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø§ÛŒØªØ§Ù„ÛŒØ§
    text_input = message.text.strip().lower()
    abroad = 0
    if text_input not in ["0", "Ù†Ø¯Ø§Ø±ÛŒÙ…", "Ù‡ÛŒÚ†", "Ø®ÛŒØ±", "none"]:
        try:
            abroad = float(text_input.replace(",", ""))
        except:
            abroad = 0
    data["current"]["abroad"] = abroad

    # Ù…Ø­Ø§Ø³Ø¨Ù‡ ISEE
    isp = data["current"]["income"] + 0.2 * data["current"]["financial"] + 0.2 * abroad
    patrimony = data["current"]["property"] + data["current"]["financial"] + abroad
    isee = round((isp + 0.2 * patrimony) / data["current"]["members"], 2)

    # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
    if "history" not in user_data[user_id]:
        user_data[user_id]["history"] = []
    user_data[user_id]["history"].append({
        "isee": isee,
        "date": datetime.now().strftime("%d/%m %H:%M")
    })
    user_data[user_id]["history"] = user_data[user_id]["history"][-5:]  # Ø¢Ø®Ø±ÛŒÙ† Ûµ Ù…Ø­Ø§Ø³Ø¨Ù‡

    # ÙˆØ¶Ø¹ÛŒØª Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ùˆ ØªØ­Ù„ÛŒÙ„
    if isee <= ISEE_LIMITS["full"]:
        status = "ğŸ‰ğŸ‰ <b>Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ú©Ø§Ù…Ù„ + Ø®ÙˆØ§Ø¨Ú¯Ø§Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†!</b> ğŸ‰ğŸ‰"
        personal_tip = "ØªØ¨Ø±ÛŒÚ©! Ø§Ø­ØªÙ…Ø§Ù„ Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ú©Ø§Ù…Ù„ Ø®ÛŒÙ„ÛŒ Ø¨Ø§Ù„Ø§Ø³Øª. Ù…Ø¯Ø§Ø±Ú© Ø±Ùˆ Ú©Ø§Ù…Ù„ Ú©Ù† Ùˆ Ø²ÙˆØ¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†!"
        color = "ğŸŸ¢"
    elif isee <= ISEE_LIMITS["partial"]:
        status = "âœ… <b>Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ø¬Ø²Ø¦ÛŒ (ØªØ§ ÛµÛ°Û°Û° ÛŒÙˆØ±Ùˆ + Ú©Ù…Ú© Ù‡Ø²ÛŒÙ†Ù‡)</b>"
        personal_tip = "Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø´Ø§Ù†Ø³ØŒ Ù‡Ø²ÛŒÙ†Ù‡ Ø²Ù†Ø¯Ú¯ÛŒ Ø±Ùˆ Ù¾Ø§ÛŒÛŒÙ† Ø¨ÛŒØ§Ø± (Ø®ÙˆØ§Ø¨Ú¯Ø§Ù‡ØŒ Ø§ØªØ§Ù‚ Ø§Ø´ØªØ±Ø§Ú©ÛŒØŒ ØºØ°Ø§ÛŒ Ø®Ø§Ù†Ú¯ÛŒ)"
        color = "ğŸŸ¡"
    elif isee <= ISEE_LIMITS["low"]:
        status = "âš ï¸ <b>Ú©Ù…Ú© Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù…</b>"
        personal_tip = "Ø¨Ø§ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ú†Ú© Ú©Ù† â€“ Ú©Ù…Ú©â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ù‡Ù… Ù‡Ø³Øª (Ú©Ø§Ø± Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒØŒ Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ø®ØµÙˆØµÛŒ)"
        color = "ğŸŸ "
    else:
        status = "âŒ <b>ØºÛŒØ± ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ø§ØµÙ„ÛŒ</b>"
        personal_tip = "Ú©Ø§Ø± Ù¾Ø§Ø±Ù‡â€ŒÙˆÙ‚ØªØŒ Ø¨ÙˆØ±Ø³ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ Ùˆ Ú©Ù…Ú© Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø±Ùˆ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†. Ù‡Ù†ÙˆØ² Ø±Ø§Ù‡ Ø²ÛŒØ§Ø¯Ù‡!"
        color = "ğŸ”´"

    # Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§ÛŒØ±Ø§Ù†ÛŒâ€ŒÙ‡Ø§
    diff = AVERAGE_ISEE_IRANIAN - isee
    if diff > 3000:
        compare = "ğŸ”¥ Ø®ÛŒÙ„ÛŒ Ø¨Ù‡ØªØ± Ø§Ø² Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø§ÛŒØ±Ø§Ù†ÛŒ! ğŸ‘"
    elif diff > -3000:
        compare = "Ù…Ø´Ø§Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø§ÛŒØ±Ø§Ù†ÛŒ"
    else:
        compare = "Ú©Ù…ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† â€“ Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ… Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ù‡ØªØ± Ú©Ù†ÛŒ"

    # Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ùˆ UX Ú©Ø§Ù…Ù„
    result = f"ğŸ§® <b>Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ISEE Ø´Ù…Ø§</b>\n\n"
    result += f"{color} <b>ISEE ØªØ®Ù…ÛŒÙ†ÛŒ:</b> <code>{isee:,.2f} â‚¬</code>\n\n"
    result += f"ğŸ‡®ğŸ‡· {compare}\n"
    result += f"(Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§ÛŒØ±Ø§Ù†ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ù¾Ø±ÙˆØ¬Ø§: ~{AVERAGE_ISEE_IRANIAN:,} â‚¬)\n\n"
    result += f"ğŸ† <b>ÙˆØ¶Ø¹ÛŒØª Ø¨ÙˆØ±Ø³ÛŒÙ‡ DSU:</b>\n{status}\n\n"
    result += f"ğŸ’¡ <b>Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø´Ø®ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§:</b>\n{personal_tip}\n\n"
    result += "ğŸ“Š <b>Ø¬Ø²Ø¦ÛŒØ§Øª ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡:</b>\n"
    result += f"ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¶Ø§: <b>{data['current']['members']} Ù†ÙØ±</b>\n"
    result += f"ğŸ’¶ Ø¯Ø±Ø¢Ù…Ø¯ Ø³Ø§Ù„Ø§Ù†Ù‡: <b>{data['current']['income']:,.2f} â‚¬</b> â‰ˆ <b>{int(data['current']['income'] * eur_rate):,} ØªÙˆÙ…Ø§Ù†</b>\n"
    result += f"ğŸ  Ø§Ø±Ø²Ø´ Ù…Ù„Ú© Ø¯Ø± Ø§ÛŒØªØ§Ù„ÛŒØ§: <b>{data['current']['property']:,.2f} â‚¬</b>\n"
    result += f"ğŸ¦ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù…Ø§Ù„ÛŒ: <b>{data['current']['financial']:,.2f} â‚¬</b>\n"
    result += f"ğŸŒ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø§ÛŒØªØ§Ù„ÛŒØ§: <b>{abroad:,.2f} â‚¬</b>\n\n"
    result += "ğŸ”¥ <b>Ù†Ú©Ø§Øª Ø·Ù„Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø¨ÙˆØ±Ø³ÛŒÙ‡:</b>\n"
    result += "â€¢ Ø²Ù†Ø¯Ú¯ÛŒ Ø§Ø´ØªØ±Ø§Ú©ÛŒ ÛŒØ§ Ø®ÙˆØ§Ø¨Ú¯Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯\n"
    result += "â€¢ Ù…Ù„Ú©ÛŒ Ø¯Ø± Ø§ÛŒØªØ§Ù„ÛŒØ§ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯\n"
    result += "â€¢ Ø¯Ø±Ø¢Ù…Ø¯ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø§Ø´Ø¯\n"
    result += "â€¢ Ø²ÙˆØ¯ØªØ± Ø§Ø² Ù‡Ù…Ù‡ Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†ÛŒØ¯\n"
    result += "â€¢ Ù…Ø¯Ø§Ø±Ú© Ø±Ø§ Ú©Ø§Ù…Ù„ Ùˆ Ø¯Ù‚ÛŒÙ‚ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯\n\n"
    result += "Ø´Ù…Ø§ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯! Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯ Ø¹Ø²ÛŒØ² ğŸ‡®ğŸ‡¹ğŸ’ªâœ¨\n\n"
    result += "<i>Ø§ÛŒÙ† Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø§Ø³Øª â€“ Ø¨Ø±Ø§ÛŒ Ø¹Ø¯Ø¯ Ø±Ø³Ù…ÛŒ Ø¨Ù‡ CAF Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.</i>"

    # Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹Ø§Ù…Ù„ Ú©Ø§Ù…Ù„
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù†ØªÛŒØ¬Ù‡ Ø¨Ø§ Ø¯ÙˆØ³ØªØ§Ù†", switch_inline_query=f"ISEE Ù…Ù† {isee:,.0f} â‚¬ Ø´Ø¯! ØªÙˆ Ú†Ù‚Ø¯Ø±ØŸ")],
        [InlineKeyboardButton(text="ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯", callback_data="isee")],
        [InlineKeyboardButton(text="ğŸ“œ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ù†", callback_data="isee_history")],
        [InlineKeyboardButton(text="â“ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨ÙˆØ±Ø³ÛŒÙ‡", callback_data="feedback")],
        [InlineKeyboardButton(text="ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ", callback_data="main_menu")]
    ])

    await message.reply(result, reply_markup=keyboard, parse_mode="HTML")

    # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ State Ùˆ Ø¯Ø§Ø¯Ù‡ Ø¬Ø§Ø±ÛŒ
    await state.clear()
    if "current" in user_data[user_id]:
        del user_data[user_id]["current"]
