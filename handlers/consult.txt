# handlers/consult_handler.py
# Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø¬Ø§Ù…Ø¹ (Ultimate Edition) - Ø¯Ø³Ø§Ù…Ø¨Ø± 2025
# Ø´Ø§Ù…Ù„: Ù…ØªØ§Ø¯ÛŒØªØ§ØŒ ÙˆØ±ÛŒÙØ§ÛŒ Ø´Ù…Ø§Ø±Ù‡ØŒ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒØŒ ÙÙ„ÙˆÚ†Ø§Ø±Øª Ú©Ø§Ù…Ù„ Ùˆ Ø¯ÛŒØªØ§ÛŒ ØªØ­ØµÛŒÙ„ÛŒ

import time
import random
import re
from datetime import datetime

from aiogram import Router, types, F
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import (
    InlineKeyboardMarkup, 
    InlineKeyboardButton, 
    ReplyKeyboardMarkup, 
    KeyboardButton, 
    ReplyKeyboardRemove
)
from config import settings, logger

router = Router()

# ---------------------------------------------------------
# 1. ØªØ¹Ø±ÛŒÙ Ù…Ø±Ø§Ø­Ù„ (States) - Ø¨Ø§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
# ---------------------------------------------------------
class ConsultState(StatesGroup):
    # Ø´Ø±ÙˆØ¹ Ùˆ Ù‡ÙˆÛŒØª
    waiting_name = State()
    waiting_age = State()
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù‡Ø§Ø¬Ø±ØªÛŒ (Ø¬Ø¯ÛŒØ¯)
    waiting_residence = State()     # Ø§Ù‚Ø§Ù…Øª ÙØ¹Ù„ÛŒ (Ø§ÛŒØ±Ø§Ù†/Ø§ÛŒØªØ§Ù„ÛŒØ§...)
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ­ØµÛŒÙ„ÛŒ (Ø¬Ø¯ÛŒØ¯)
    waiting_edu_level = State()     # Ù…Ø¯Ø±Ú© ÙØ¹Ù„ÛŒ
    waiting_grad_year = State()     # Ø³Ø§Ù„ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ
    waiting_lang_cert = State()     # Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù†
    
    # Ù‡Ø¯Ù Ùˆ Ø²Ø¨Ø§Ù†
    waiting_language_level = State() # Ø³Ø·Ø­ Ø¯Ø§Ù†Ø´ Ø²Ø¨Ø§Ù†
    waiting_goal = State()          # Ù‡Ø¯Ù (Ù„ÛŒØ³Ø§Ù†Ø³/Ø§Ø±Ø´Ø¯...)
    
    # Ù…Ø§Ù„ÛŒ Ùˆ Ù„Ø¬Ø³ØªÛŒÚ©
    waiting_budget = State()
    waiting_arrival = State()       # ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯
    
    # ØªÙ…Ø§Ø³ Ùˆ Ù¾Ø§ÛŒØ§Ù†
    waiting_phone = State()
    waiting_extra = State()

# ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
TOTAL_STEPS = 12 

# ---------------------------------------------------------
# 2. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
# ---------------------------------------------------------
def get_progress(step: int) -> str:
    """Ø³Ø§Ø®Øª Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ"""
    percent = int((step / TOTAL_STEPS) * 100)
    filled_len = int(10 * step / TOTAL_STEPS)
    bar = "â–ˆ" * filled_len + "â–‘" * (10 - filled_len)
    return f"ğŸ“ˆ <b>Ù¾ÛŒØ´Ø±ÙØª: {percent}%</b>\n[{bar}]\n"

def generate_consult_id(user_id: int) -> str:
    """ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ ÛŒÚ©ØªØ§ (Ù…Ø«Ù„Ø§Ù‹ CS-8492-12)"""
    timestamp_part = str(int(time.time()))[-4:] # Û´ Ø±Ù‚Ù… Ø¢Ø®Ø± Ø²Ù…Ø§Ù†
    uid_part = str(user_id)[-2:]                # Û² Ø±Ù‚Ù… Ø¢Ø®Ø± Ø¢ÛŒØ¯ÛŒ
    return f"CS-{timestamp_part}-{uid_part}"

# ---------------------------------------------------------
# 3. Ø´Ø±ÙˆØ¹ Ù…Ø´Ø§ÙˆØ±Ù‡ (Intro) - Ø¨Ø§ Ù„Ø­Ù† ØµÙ…ÛŒÙ…Ø§Ù†Ù‡
# ---------------------------------------------------------
@router.callback_query(F.data == "consult")
async def consult_intro(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    user = callback.from_user
    name = user.first_name if user.first_name else "Ø¯ÙˆØ³Øª Ø¹Ø²ÛŒØ²"
    
    text = f"ğŸ‘‹ <b>Ø³Ù„Ø§Ù… {name} Ø¹Ø²ÛŒØ²! Ø¨Ù‡ Ø¨Ø®Ø´ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ.</b>\n\n"
    text += "Ù…Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒÙ… Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ÛŒÙ† Ùˆ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø³ÛŒØ± Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª ØªØ­ØµÛŒÙ„ÛŒ ØªÙˆ Ø·Ø±Ø§Ø­ÛŒ Ú©Ù†ÛŒÙ…. ğŸ›ğŸ‡®ğŸ‡¹\n\n"
    text += "ğŸ’¡ <b>Ú†Ø±Ø§ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† ÙØ±Ù… Ø±Ùˆ Ù¾Ø± Ú©Ù†ÛŒØŸ</b>\n"
    text += "Ú†ÙˆÙ† Ø´Ø±Ø§ÛŒØ· Ù‡Ø± Ø¯Ø§Ù†Ø´Ø¬Ùˆ (Ø³Ù†ØŒ Ù…Ø¹Ø¯Ù„ØŒ Ø¨ÙˆØ¯Ø¬Ù‡) Ù…ØªÙØ§ÙˆØªÙ‡. Ø¨Ø§ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø§ÛŒÙ† Ø³ÙˆØ§Ù„Ø§ØªØŒ Ù…Ø´Ø§ÙˆØ±Ø§Ù† Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†Ù†:\n"
    text += "âœ… Ø´Ø§Ù†Ø³ Ù¾Ø°ÛŒØ±Ø´ ØªÙˆ Ø±Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†Ù†\n"
    text += "âœ… Ø¨Ù‡ØªØ±ÛŒÙ† Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù†\n"
    text += "âœ… Ø±Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ø¨ÙˆØ±Ø³ÛŒÙ‡ Ø±Ùˆ Ø¨Ù‡Øª Ø¨Ú¯Ù†\n\n"
    text += "â± <b>Ø²Ù…Ø§Ù† Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²:</b> ÙÙ‚Ø· Û³ Ø¯Ù‚ÛŒÙ‚Ù‡\n"
    text += "ğŸ”’ Ø§Ø·Ù„Ø§Ø¹Ø§ØªØª Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ù…ÛŒâ€ŒÙ…ÙˆÙ†Ù‡.\n\n"
    text += "Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡â€ŒØª Ø±Ùˆ Ø¨Ø³Ø§Ø²ÛŒØŸ Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ…! ğŸ‘‡"

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸš€ Ø´Ø±ÙˆØ¹ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†", callback_data="consult_start_form")],
        [InlineKeyboardButton(text="ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="main_menu")]
    ])
    
    # Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† Ø§Ø¯ÛŒØª Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„ÛŒ Ø¹Ú©Ø³ Ø¨ÙˆØ¯
    if callback.message.content_type == types.ContentType.PHOTO:
        await callback.message.delete()
        await callback.message.answer(text, reply_markup=kb, parse_mode="HTML")
    else:
        await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    await callback.answer()
# Ø§Ø¯Ø§Ù…Ù‡ ÙØ§ÛŒÙ„ handlers/consult_handler.py
# Ø¨Ø®Ø´ Û²: Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ø¯ÛŒ Ùˆ ØªØ­ØµÛŒÙ„ÛŒ Ù¾Ø§ÛŒÙ‡

# ---------------------------------------------------------
# Ø´Ø±ÙˆØ¹ ÙØ±Ù… (Step 1) - Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù…
# ---------------------------------------------------------
@router.callback_query(F.data == "consult_start_form")
async def start_consult_form(callback: types.CallbackQuery, state: FSMContext):
    # Ø°Ø®ÛŒØ±Ù‡ Ù…ØªØ§Ø¯ÛŒØªØ§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ø§Ø±Ø¨Ø± (Ø¨Ø±Ø§ÛŒ Ø§Ø­ØªÛŒØ§Ø·)
    user = callback.from_user
    await state.update_data(
        telegram_id=user.id,
        username=user.username,
        full_name=user.full_name,
        step=1
    )
    
    await state.set_state(ConsultState.waiting_name)
    
    text = get_progress(1)
    text += "ğŸ‘¤ <b>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:</b>\n"
    text += "<i>(Ù„Ø·ÙØ§Ù‹ ÙØ§Ø±Ø³ÛŒ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯ - Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ)</i>"

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ”™ Ø§Ù†ØµØ±Ø§Ù", callback_data="main_menu")]
    ])
    
    await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    await callback.answer()

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û± -> Û²: Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ù†
# ---------------------------------------------------------
@router.message(ConsultState.waiting_name)
async def process_name(message: types.Message, state: FSMContext):
    name = message.text.strip()
    if len(name) < 3:
        await message.reply("âš ï¸ Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ù…Ù„ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.")
        return
        
    await state.update_data(name=name, step=2)
    await state.set_state(ConsultState.waiting_age)
    
    text = f"âœ… Ù†Ø§Ù…: <b>{name}</b>\n\n"
    text += get_progress(2)
    text += "ğŸ‚ <b>Ø³Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</b>\n"
    text += "<i>Ù…Ø«Ø§Ù„: 23</i>"
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    await message.reply(text, reply_markup=kb, parse_mode="HTML")

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û² -> Û³: Ø¯Ø±ÛŒØ§ÙØª Ø³Ù† -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ù‚Ø§Ù…Øª
# ---------------------------------------------------------
@router.message(ConsultState.waiting_age)
async def process_age(message: types.Message, state: FSMContext):
    try:
        age = int(message.text.strip())
        if not 14 <= age <= 99:
            raise ValueError
    except ValueError:
        await message.reply("âš ï¸ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø³Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
        return

    await state.update_data(age=age, step=3)
    await state.set_state(ConsultState.waiting_residence)
    
    text = f"âœ… Ø³Ù†: <b>{age}</b>\n\n"
    text += get_progress(3)
    text += "ğŸŒ <b>Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ú©Ø¬Ø§ Ø²Ù†Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ</b>\n"
    text += "(Ø§ÛŒÙ† Ø³ÙˆØ§Ù„ Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† Ù…Ø³ÛŒØ± ÙˆÛŒØ²Ø§ Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù… Ø§Ø³Øª)"
    
    # Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ù‚Ø§Ù…Øª
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ‡®ğŸ‡· Ø¯Ø§Ø®Ù„ Ø§ÛŒØ±Ø§Ù†", callback_data="consult_res_iran")],
        [InlineKeyboardButton(text="ğŸ‡®ğŸ‡¹ Ø¯Ø§Ø®Ù„ Ø§ÛŒØªØ§Ù„ÛŒØ§", callback_data="consult_res_italy")],
        [InlineKeyboardButton(text="ğŸ‡ªğŸ‡º Ø§Ø±ÙˆÙ¾Ø§ (ØºÛŒØ± Ø§Ø² Ø§ÛŒØªØ§Ù„ÛŒØ§)", callback_data="consult_res_eu")],
        [InlineKeyboardButton(text="ğŸŒ Ø³Ø§ÛŒØ± Ú©Ø´ÙˆØ±Ù‡Ø§", callback_data="consult_res_other")],
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    
    await message.reply(text, reply_markup=kb, parse_mode="HTML")

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û³ -> Û´: Ø¯Ø±ÛŒØ§ÙØª Ø§Ù‚Ø§Ù…Øª -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ
# ---------------------------------------------------------
@router.callback_query(ConsultState.waiting_residence, F.data.startswith("consult_res_"))
async def process_residence(callback: types.CallbackQuery, state: FSMContext):
    # Ù†Ú¯Ø§Ø´Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    res_map = {
        "consult_res_iran": "Ø§ÛŒØ±Ø§Ù†",
        "consult_res_italy": "Ø§ÛŒØªØ§Ù„ÛŒØ§",
        "consult_res_eu": "Ø§Ø±ÙˆÙ¾Ø§",
        "consult_res_other": "Ø³Ø§ÛŒØ±"
    }
    residence = res_map.get(callback.data, "Ù†Ø§Ù…Ø´Ø®Øµ")
    
    await state.update_data(residence=residence, step=4)
    await state.set_state(ConsultState.waiting_edu_level)
    
    text = f"âœ… Ø§Ù‚Ø§Ù…Øª: <b>{residence}</b>\n\n"
    text += get_progress(4)
    text += "ğŸ“ <b>Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ Ø´Ù…Ø§ Ú†ÛŒØ³ØªØŸ</b>\n"
    text += "(ÛŒØ§ Ù…Ø¯Ø±Ú©ÛŒ Ú©Ù‡ Ø§Ù„Ø§Ù† Ù…Ø´ØºÙˆÙ„ ØªØ­ØµÛŒÙ„ Ø¯Ø± Ø¢Ù† Ù‡Ø³ØªÛŒØ¯)"
    
    # Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ“˜ Ø¯ÛŒÙ¾Ù„Ù… / Ù¾ÛŒØ´â€ŒØ¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ", callback_data="consult_edu_diploma")],
        [InlineKeyboardButton(text="ğŸ“ Ù„ÛŒØ³Ø§Ù†Ø³ (Bachelor)", callback_data="consult_edu_bachelor")],
        [InlineKeyboardButton(text="ğŸ“ ÙÙˆÙ‚ Ù„ÛŒØ³Ø§Ù†Ø³ (Master)", callback_data="consult_edu_master")],
        [InlineKeyboardButton(text="ğŸ“ Ø¯Ú©ØªØ±ÛŒ (PhD)", callback_data="consult_edu_phd")],
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    
    await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    await callback.answer()
# Ø§Ø¯Ø§Ù…Ù‡ ÙØ§ÛŒÙ„ handlers/consult_handler.py
# Ø¨Ø®Ø´ Û³: Ø³ÙˆØ§Ø¨Ù‚ ØªØ­ØµÛŒÙ„ÛŒ Ùˆ Ø²Ø¨Ø§Ù†ÛŒ

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û´ -> Ûµ: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø§Ù„ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ
# ---------------------------------------------------------
@router.callback_query(ConsultState.waiting_edu_level, F.data.startswith("consult_edu_"))
async def process_edu_level(callback: types.CallbackQuery, state: FSMContext):
    # Ù†Ú¯Ø§Ø´Øª Ù…Ù‚Ø§Ø¯ÛŒØ±
    edu_map = {
        "consult_edu_diploma": "Ø¯ÛŒÙ¾Ù„Ù… / Ù¾ÛŒØ´â€ŒØ¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ",
        "consult_edu_bachelor": "Ù„ÛŒØ³Ø§Ù†Ø³",
        "consult_edu_master": "ÙÙˆÙ‚ Ù„ÛŒØ³Ø§Ù†Ø³",
        "consult_edu_phd": "Ø¯Ú©ØªØ±ÛŒ"
    }
    edu_level = edu_map.get(callback.data, "Ù†Ø§Ù…Ø´Ø®Øµ")
    
    await state.update_data(edu_level=edu_level, step=5)
    await state.set_state(ConsultState.waiting_grad_year)
    
    text = f"âœ… Ù…Ø¯Ø±Ú© ÙØ¹Ù„ÛŒ: <b>{edu_level}</b>\n\n"
    text += get_progress(5)
    text += "ğŸ“… <b>Ø³Ø§Ù„ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ (ÛŒØ§ Ø³Ø§Ù„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ù¾Ø§ÛŒØ§Ù† ØªØ­ØµÛŒÙ„)ØŸ</b>\n"
    text += "ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø³Ø§Ù„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.\n"
    text += "<i>Ù…Ø«Ø§Ù„: 2022 ÛŒØ§ 2025</i>"
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    
    await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    await callback.answer()

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Ûµ -> Û¶: Ø¯Ø±ÛŒØ§ÙØª Ø³Ø§Ù„ -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù†
# ---------------------------------------------------------
@router.message(ConsultState.waiting_grad_year)
async def process_grad_year(message: types.Message, state: FSMContext):
    try:
        year_str = message.text.strip()
        # ØªØ¨Ø¯ÛŒÙ„ Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø³Ø§Ø¯Ù‡ (Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ø´Ù…Ø³ÛŒ Ø²Ø¯)
        if len(year_str) == 4 and year_str.isdigit():
            year = int(year_str)
            if 1300 < year < 1500: # Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø´Ù…Ø³ÛŒ Ø§Ø³Øª
                year += 621
            elif not (1980 <= year <= 2030): # Ù…Ø­Ø¯ÙˆØ¯Ù‡ ØºÛŒØ±Ù…Ù†Ø·Ù‚ÛŒ
                raise ValueError
        else:
            raise ValueError
    except ValueError:
        await message.reply("âš ï¸ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø³Ø§Ù„ Ù…Ø¹ØªØ¨Ø± Ù…ÛŒÙ„Ø§Ø¯ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 2023).")
        return

    await state.update_data(grad_year=year, step=6)
    await state.set_state(ConsultState.waiting_lang_cert)
    
    text = f"âœ… Ø³Ø§Ù„ Ù…Ø¯Ø±Ú©: <b>{year}</b>\n\n"
    text += get_progress(6)
    text += "ğŸ“œ <b>Ø¢ÛŒØ§ Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù† Ø±Ø³Ù…ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ</b>\n"
    text += "(Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ²Ø§ÛŒ Ø§ÛŒØªØ§Ù„ÛŒØ§ØŒ Ø¯Ø§Ø´ØªÙ† Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù† Ø´Ø§Ù†Ø³ Ø±Ø§ Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØ¨Ø±Ø¯)"
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="IELTS Academic", callback_data="consult_cert_ielts")],
        [InlineKeyboardButton(text="TOEFL iBT", callback_data="consult_cert_toefl")],
        [InlineKeyboardButton(text="Duolingo", callback_data="consult_cert_duolingo")],
        [InlineKeyboardButton(text="TOLC / CILS / CELI (Ø§ÛŒØªØ§Ù„ÛŒØ§ÛŒÛŒ)", callback_data="consult_cert_italian")],
        [InlineKeyboardButton(text="âŒ ÙØ¹Ù„Ø§Ù‹ Ù†Ø¯Ø§Ø±Ù…", callback_data="consult_cert_none")],
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    
    await message.reply(text, reply_markup=kb, parse_mode="HTML")

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û¶ -> Û·: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù† -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø·Ø­ Ø²Ø¨Ø§Ù†
# ---------------------------------------------------------
@router.callback_query(ConsultState.waiting_lang_cert, F.data.startswith("consult_cert_"))
async def process_lang_cert(callback: types.CallbackQuery, state: FSMContext):
    cert_map = {
        "consult_cert_ielts": "IELTS",
        "consult_cert_toefl": "TOEFL",
        "consult_cert_duolingo": "Duolingo",
        "consult_cert_italian": "Ù…Ø¯Ø±Ú© Ø§ÛŒØªØ§Ù„ÛŒØ§ÛŒÛŒ",
        "consult_cert_none": "Ù†Ø¯Ø§Ø±Ø¯"
    }
    cert = cert_map.get(callback.data, "Ù†Ø§Ù…Ø´Ø®Øµ")
    
    await state.update_data(lang_cert=cert, step=7)
    await state.set_state(ConsultState.waiting_language_level)
    
    text = f"âœ… Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù†: <b>{cert}</b>\n\n"
    text += get_progress(7)
    text += "ğŸ—£ <b>Ø³Ø·Ø­ Ø¯Ø§Ù†Ø´ Ø²Ø¨Ø§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ú†Ø·ÙˆØ± Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ</b>\n"
    text += "(Ú†Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ú†Ù‡ Ø§ÛŒØªØ§Ù„ÛŒØ§ÛŒÛŒ)"
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="Ù…Ø¨ØªØ¯ÛŒ (Beginner - A1/A2)", callback_data="consult_lvl_beginner")],
        [InlineKeyboardButton(text="Ù…ØªÙˆØ³Ø· (Intermediate - B1/B2)", callback_data="consult_lvl_mid")],
        [InlineKeyboardButton(text="Ù¾ÛŒØ´Ø±ÙØªÙ‡ (Advanced - C1/C2)", callback_data="consult_lvl_adv")],
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    
    await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    await callback.answer()

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û· -> Û¸: Ø¯Ø±ÛŒØ§ÙØª Ø³Ø·Ø­ Ø²Ø¨Ø§Ù† -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ø¯Ù ØªØ­ØµÛŒÙ„ÛŒ
# ---------------------------------------------------------
@router.callback_query(ConsultState.waiting_language_level, F.data.startswith("consult_lvl_"))
async def process_lang_level(callback: types.CallbackQuery, state: FSMContext):
    lvl_map = {
        "consult_lvl_beginner": "Ù…Ø¨ØªØ¯ÛŒ (A1-A2)",
        "consult_lvl_mid": "Ù…ØªÙˆØ³Ø· (B1-B2)",
        "consult_lvl_adv": "Ù¾ÛŒØ´Ø±ÙØªÙ‡ (C1-C2)"
    }
    level = lvl_map.get(callback.data, "Ù†Ø§Ù…Ø´Ø®Øµ")
    
    await state.update_data(language_level=level, step=8)
    await state.set_state(ConsultState.waiting_goal)
    
    text = f"âœ… Ø³Ø·Ø­ Ø²Ø¨Ø§Ù†: <b>{level}</b>\n\n"
    text += get_progress(8)
    text += "ğŸ¯ <b>Ù‡Ø¯Ù Ø´Ù…Ø§ ØªØ­ØµÛŒÙ„ Ø¯Ø± Ú†Ù‡ Ù…Ù‚Ø·Ø¹ÛŒ Ø§Ø³ØªØŸ</b>"
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ“ Ù„ÛŒØ³Ø§Ù†Ø³ (Bachelor)", callback_data="consult_goal_bachelor")],
        [InlineKeyboardButton(text="ğŸ“ ÙÙˆÙ‚ Ù„ÛŒØ³Ø§Ù†Ø³ (Master)", callback_data="consult_goal_master")],
        [InlineKeyboardButton(text="ğŸ“ Ø¯Ú©ØªØ±ÛŒ (PhD)", callback_data="consult_goal_phd")],
        [InlineKeyboardButton(text="ğŸ©º Ù¾Ø²Ø´Ú©ÛŒ / Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ¾Ø²Ø´Ú©ÛŒ / Ø¯Ø§Ø±ÙˆØ³Ø§Ø²ÛŒ", callback_data="consult_goal_med")],
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    
    await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    await callback.answer()
# Ø§Ø¯Ø§Ù…Ù‡ ÙØ§ÛŒÙ„ handlers/consult_handler.py
# Ø¨Ø®Ø´ Û´: Ø¨ÙˆØ¯Ø¬Ù‡ØŒ Ù„Ø¬Ø³ØªÛŒÚ© Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û¸ -> Û¹: Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯Ù ØªØ­ØµÛŒÙ„ÛŒ -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨ÙˆØ¯Ø¬Ù‡
# ---------------------------------------------------------
@router.callback_query(ConsultState.waiting_goal, F.data.startswith("consult_goal_"))
async def process_goal(callback: types.CallbackQuery, state: FSMContext):
    goal_map = {
        "consult_goal_bachelor": "Ù„ÛŒØ³Ø§Ù†Ø³",
        "consult_goal_master": "ÙÙˆÙ‚ Ù„ÛŒØ³Ø§Ù†Ø³",
        "consult_goal_phd": "Ø¯Ú©ØªØ±ÛŒ",
        "consult_goal_med": "Ù¾Ø²Ø´Ú©ÛŒ/Ø¯Ø§Ø±ÙˆØ³Ø§Ø²ÛŒ"
    }
    goal = goal_map.get(callback.data, "Ù†Ø§Ù…Ø´Ø®Øµ")
    
    await state.update_data(study_goal=goal, step=9)
    await state.set_state(ConsultState.waiting_budget)
    
    text = f"âœ… Ù‡Ø¯Ù: <b>{goal}</b>\n\n"
    text += get_progress(9)
    text += "ğŸ’° <b>Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø²Ù†Ø¯Ú¯ÛŒ Ú†Ù‚Ø¯Ø± Ø§Ø³ØªØŸ</b>\n"
    text += "(Ø¨Ø¯ÙˆÙ† Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ† Ø´Ù‡Ø±ÛŒÙ‡ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ - ÙÙ‚Ø· Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø³Ú©Ù† Ùˆ Ø®ÙˆØ±Ø§Ú©)\n"
    text += "<i>Ù…Ø«Ø§Ù„: 700</i>"
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    
    await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    await callback.answer()

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û¹ -> Û±Û°: Ø¯Ø±ÛŒØ§ÙØª Ø¨ÙˆØ¯Ø¬Ù‡ -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯
# ---------------------------------------------------------
@router.message(ConsultState.waiting_budget)
async def process_budget(message: types.Message, state: FSMContext):
    try:
        # Ø­Ø°Ù Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ± Ø¹Ø¯Ø¯ÛŒ
        budget_str = re.sub(r'\D', '', message.text)
        budget = int(budget_str)
    except ValueError:
        await message.reply("âš ï¸ Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 800).")
        return

    await state.update_data(budget=budget, step=10)
    await state.set_state(ConsultState.waiting_arrival)
    
    text = f"âœ… Ø¨ÙˆØ¯Ø¬Ù‡: <b>{budget} ÛŒÙˆØ±Ùˆ</b>\n\n"
    text += get_progress(10)
    text += "ğŸ“… <b>Ø¨Ø±Ø§ÛŒ Ú†Ù‡ Ø³Ø§Ù„ÛŒ ÛŒØ§ Ú†Ù‡ ØªØ±Ù…ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ</b>\n"
    text += "<i>Ù…Ø«Ø§Ù„: Ø³Ù¾ØªØ§Ù…Ø¨Ø± 2025 ÛŒØ§ ØªØ±Ù… Ø²Ù…Ø³ØªØ§Ù†</i>"
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    
    await message.reply(text, reply_markup=kb, parse_mode="HTML")

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û±Û° -> Û±Û±: Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ® -> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§Ø±Ù‡ (Ø§Ù…Ù†)
# ---------------------------------------------------------
@router.message(ConsultState.waiting_arrival)
async def process_arrival(message: types.Message, state: FSMContext):
    arrival = message.text.strip()
    await state.update_data(arrival_date=arrival, step=11)
    
    text = f"âœ… ØªØ§Ø±ÛŒØ® Ø¨Ø±Ù†Ø§Ù…Ù‡: <b>{arrival}</b>\n\n"
    text += get_progress(11)
    text += "ğŸ“± <b>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:</b>\n\n"
    text += "Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Ø¨ÛŒØ´ØªØ±ØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ Ø«Ø¨Øª Ø´ÙˆØ¯.\n"
    text += "(Ø§Ú¯Ø± Ø´Ù…Ø§Ø±Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ù†Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¯Ø³ØªÛŒ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯)"

    # Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ø§Ù†ØªÚ©Øª (Ø§Ù…Ù†ÛŒØª Ø¨Ø§Ù„Ø§)
    phone_kb = ReplyKeyboardMarkup(keyboard=[
        [KeyboardButton(text="ğŸ“± Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ù…Ù†", request_contact=True)]
    ], resize_keyboard=True, one_time_keyboard=True)
    
    await message.reply(text, reply_markup=phone_kb, parse_mode="HTML")
    await state.set_state(ConsultState.waiting_phone)

# ---------------------------------------------------------
# Ù…Ø±Ø­Ù„Ù‡ Û±Û± -> Û±Û²: Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ùˆ Ø§Ø¹ØªØ¨Ø§Ø± Ø³Ù†Ø¬ÛŒ
# ---------------------------------------------------------
@router.message(ConsultState.waiting_phone)
async def process_phone(message: types.Message, state: FSMContext):
    phone = ""
    is_verified = False
    
    # Ø­Ø§Ù„Øª Û±: Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù†ØªÚ©Øª (Ù…Ø¹ØªØ¨Ø±)
    if message.contact:
        phone = message.contact.phone_number
        is_verified = True
        # Ø§Ú¯Ø± Ø´Ù…Ø§Ø±Ù‡ Ø¨Ø§ + Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯ØŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        if not phone.startswith("+"):
            phone = "+" + phone
            
    # Ø­Ø§Ù„Øª Û²: ØªØ§ÛŒÙ¾ Ø¯Ø³ØªÛŒ (Ù†Ø§Ù…Ø¹ØªØ¨Ø±/Ø¯Ø³ØªÛŒ)
    else:
        phone = message.text.strip()
        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø§Ø¯Ù‡ regex
        if not re.match(r"^\+?[\d\s\-]{10,15}$", phone):
            await message.reply("âš ï¸ Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
            return
        is_verified = False

    await state.update_data(phone=phone, phone_verified=is_verified, step=12)
    await state.set_state(ConsultState.waiting_extra)
    
    # Ø­Ø°Ù Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø´Ù…Ø§Ø±Ù‡
    loading_msg = await message.reply("â³ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...", reply_markup=ReplyKeyboardRemove())
    await loading_msg.delete()
    
    text = f"âœ… Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³: <b>{phone}</b> {'(ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ âœ…)' if is_verified else '(Ø¯Ø³ØªÛŒ âš ï¸)'}\n\n"
    text += get_progress(12)
    text += "ğŸ“ <b>ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</b>\n"
    text += "Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ ÛŒØ§ Ù†Ú©ØªÙ‡â€ŒØ§ÛŒ Ù‡Ø³Øª Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ø¯Ø§Ù†ÛŒÙ…ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.\n\n"
    text += "Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø¯Ú©Ù…Ù‡ Â«Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯."
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="âœ… Ø«Ø¨Øª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ", callback_data="consult_finish_skip")],
        [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
    ])
    
    await message.answer(text, reply_markup=kb, parse_mode="HTML")
# Ø§Ø¯Ø§Ù…Ù‡ ÙØ§ÛŒÙ„ handlers/consult_handler.py
# Ø¨Ø®Ø´ Ûµ: Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒØŒ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø¯Ù…ÛŒÙ† Ùˆ Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ø²Ú¯Ø´Øª

# ---------------------------------------------------------
# Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ (Ù…ØªÙ† ÛŒØ§ Ø¯Ú©Ù…Ù‡ Ø±Ø¯ Ú©Ø±Ø¯Ù†)
# ---------------------------------------------------------
@router.message(ConsultState.waiting_extra)
async def process_extra_text(message: types.Message, state: FSMContext):
    await state.update_data(extra=message.text.strip())
    await finalize_consult(message, state)

@router.callback_query(ConsultState.waiting_extra, F.data == "consult_finish_skip")
async def process_extra_skip(callback: types.CallbackQuery, state: FSMContext):
    await state.update_data(extra="Ù†Ø¯Ø§Ø±Ø¯")
    await finalize_consult(callback.message, state)
    await callback.answer()

# ---------------------------------------------------------
# ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ (Engine)
# ---------------------------------------------------------
async def finalize_consult(message: types.Message, state: FSMContext):
    data = await state.get_data()
    user = message.chat  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² chat Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    
    # 1. ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ Ùˆ Ù…ØªØ§Ø¯ÛŒØªØ§
    consult_id = generate_consult_id(user.id)
    username_txt = f"@{user.username}" if user.username else "Ù†Ø¯Ø§Ø±Ø¯"
    user_link = f"<a href='tg://user?id={user.id}'>{user.full_name}</a>"
    
    # 2. Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ø´Ù…Ø§Ø±Ù‡
    phone_status = "âœ… ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ (Contact)" if data.get('phone_verified') else "âš ï¸ Ø¯Ø³ØªÛŒ (ØªØ§ÛŒÙ¾ Ø´Ø¯Ù‡)"
    
    # 3. Ø³Ø§Ø®Øª Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
    admin_msg = f"ğŸ”” <b>Ù„ÛŒØ¯ Ø¬Ø¯ÛŒØ¯ Ù…Ø´Ø§ÙˆØ±Ù‡ ØªØ­ØµÛŒÙ„ÛŒ</b>\n"
    admin_msg += f"ğŸ”– Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: <code>{consult_id}</code>\n"
    admin_msg += "â–â–â–â–â–â–â–â–â–â–\n"
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ (Metadata)
    admin_msg += "ğŸ‘¤ <b>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±:</b>\n"
    admin_msg += f"â€¢ Ù†Ø§Ù…: {user_link}\n"
    admin_msg += f"â€¢ Ø¢ÛŒØ¯ÛŒ: <code>{user.id}</code>\n"
    admin_msg += f"â€¢ ÛŒÙˆØ²Ø±Ù†ÛŒÙ…: {username_txt}\n"
    admin_msg += f"â€¢ Ø²Ø¨Ø§Ù† ØªÙ„Ú¯Ø±Ø§Ù…: {user.id}\n\n" # Ø¯Ø± Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ aiogram Ø§Ø¨Ø¬Ú©Øª user Ø²Ø¨Ø§Ù† Ø±Ø§ Ø¯Ø§Ø±Ø¯
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…ØªÙ‚Ø§Ø¶ÛŒ
    admin_msg += "ğŸ“ <b>Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…ØªÙ‚Ø§Ø¶ÛŒ:</b>\n"
    admin_msg += f"â€¢ Ù†Ø§Ù… Ø«Ø¨Øª Ø´Ø¯Ù‡: {data.get('name')}\n"
    admin_msg += f"â€¢ Ø³Ù†: {data.get('age')}\n"
    admin_msg += f"â€¢ Ø§Ù‚Ø§Ù…Øª ÙØ¹Ù„ÛŒ: {data.get('residence')}\n\n"
    
    # Ø³ÙˆØ§Ø¨Ù‚ ØªØ­ØµÛŒÙ„ÛŒ
    admin_msg += "ğŸ“ <b>Ø³ÙˆØ§Ø¨Ù‚ ØªØ­ØµÛŒÙ„ÛŒ:</b>\n"
    admin_msg += f"â€¢ Ù…Ù‚Ø·Ø¹ ÙØ¹Ù„ÛŒ: {data.get('edu_level')}\n"
    admin_msg += f"â€¢ Ø³Ø§Ù„ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ: {data.get('grad_year')}\n"
    admin_msg += f"â€¢ Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù†: {data.get('lang_cert')}\n"
    admin_msg += f"â€¢ Ø³Ø·Ø­ Ø²Ø¨Ø§Ù† (Ø®ÙˆØ¯Ø§Ø¸Ù‡Ø§Ø±ÛŒ): {data.get('language_level')}\n\n"
    
    # Ù‡Ø¯Ù Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡
    admin_msg += "ğŸ¯ <b>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ù‡Ø§Ø¬Ø±Øª:</b>\n"
    admin_msg += f"â€¢ Ù‡Ø¯Ù: {data.get('study_goal')}\n"
    admin_msg += f"â€¢ Ø±Ø´ØªÙ‡/Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡: {data.get('field_university')}\n"
    admin_msg += f"â€¢ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡: {data.get('budget')} ÛŒÙˆØ±Ùˆ\n"
    admin_msg += f"â€¢ Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯: {data.get('arrival_date')}\n\n"
    
    # ØªÙ…Ø§Ø³ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª
    admin_msg += "ğŸ“ <b>Ø§Ø±ØªØ¨Ø§Ø·:</b>\n"
    admin_msg += f"â€¢ Ø´Ù…Ø§Ø±Ù‡: <code>{data.get('phone')}</code>\n"
    admin_msg += f"â€¢ ÙˆØ¶Ø¹ÛŒØª Ø´Ù…Ø§Ø±Ù‡: {phone_status}\n"
    admin_msg += f"â€¢ ØªÙˆØ¶ÛŒØ­Ø§Øª: {data.get('extra')}\n"
    admin_msg += "â–â–â–â–â–â–â–â–â–â–\n"
    admin_msg += f"â° {datetime.now().strftime('%Y-%m-%d %H:%M')}"

    # Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ
    kb_admin = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ’¬ Ù¾ÛŒØ§Ù… Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±", url=f"tg://user?id={user.id}")],
        [InlineKeyboardButton(text="âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯ (Ø¨Ø³ØªÙ† Ù¾Ø±ÙˆÙ†Ø¯Ù‡)", callback_data=f"consult_mark_done_{consult_id}")]
    ])
    
    # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§
    for admin_id in settings.ADMIN_CHAT_IDS:
        try:
            await message.bot.send_message(admin_id, admin_msg, reply_markup=kb_admin, parse_mode="HTML")
        except Exception as e:
            logger.error(f"Error sending lead to admin {admin_id}: {e}")

    # 4. Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± (Ø¨Ø§ Ù„ÛŒØ¯ Ù…Ú¯Ù†Øª)
    final_text = f"ğŸ‰ <b>{data.get('name')} Ø¹Ø²ÛŒØ²ØŒ Ø¯Ø±Ø®ÙˆØ§Ø³ØªØª Ø«Ø¨Øª Ø´Ø¯!</b>\n\n"
    final_text += f"ğŸ”– <b>Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ Ø´Ù…Ø§:</b> <code>{consult_id}</code>\n\n"
    final_text += "Ù…Ø´Ø§ÙˆØ±Ø§Ù† Ù…Ø§ ÙØ±Ù… Ø´Ù…Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¸Ø±Ù Û²Û´ Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… ÛŒØ§ ÙˆØ§ØªØ³â€ŒØ§Ù¾ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯.\n\n"
    final_text += "ğŸ <b>Ù‡Ø¯ÛŒÙ‡ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§:</b>\n"
    final_text += "ØªØ§ Ø²Ù…Ø§Ù† ØªÙ…Ø§Ø³ Ù…Ø´Ø§ÙˆØ±ØŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Â«Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ø²Ù†Ø¯Ú¯ÛŒ Ø¯Ø± Ù¾Ø±ÙˆØ¬Ø§Â» Ø±Ø§ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ø§ Ø´Ù‡Ø± Ø¢ÛŒÙ†Ø¯Ù‡â€ŒØªØ§Ù† Ø¢Ø´Ù†Ø§ Ø´ÙˆÛŒØ¯ ğŸ‘‡"

    kb_user = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ“– Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù¾Ø±ÙˆØ¬Ø§", callback_data="guide_main")],
        [InlineKeyboardButton(text="ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡", callback_data="main_menu")]
    ])
    
    if isinstance(message, types.Message):
        await message.answer(final_text, reply_markup=kb_user, parse_mode="HTML")
    else:
        await message.edit_text(final_text, reply_markup=kb_user, parse_mode="HTML")
    
    await state.clear()

# ---------------------------------------------------------
# Ù‡Ù†Ø¯Ù„Ø± ÙˆØ¶Ø¹ÛŒØª "Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯" ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ†
# ---------------------------------------------------------
@router.callback_query(F.data.startswith("consult_mark_done_"))
async def mark_lead_done(callback: types.CallbackQuery):
    try:
        # ØªØºÛŒÛŒØ± Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ
        cid = callback.data.split("_")[-1]
        admin_name = callback.from_user.first_name
        
        new_text = callback.message.html_text
        new_text += f"\n\nâœ… <b>Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· {admin_name}</b>"
        
        await callback.message.edit_text(new_text, reply_markup=None, parse_mode="HTML")
        await callback.answer(f"Ù¾Ø±ÙˆÙ†Ø¯Ù‡ {cid} Ø¨Ø³ØªÙ‡ Ø´Ø¯.")
    except Exception as e:
        await callback.answer("Ø®Ø·Ø§ ÛŒØ§ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡.")

# ---------------------------------------------------------
# Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ø²Ú¯Ø´Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ (Smart Back Navigation)
# ---------------------------------------------------------
@router.callback_query(F.data == "consult_back")
async def consult_back_handler(callback: types.CallbackQuery, state: FSMContext):
    current_state = await state.get_state()
    data = await state.get_data()
    
    # 1. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² Ø³Ù† Ø¨Ù‡ Ù†Ø§Ù…
    if current_state == ConsultState.waiting_age.state:
        await state.set_state(ConsultState.waiting_name)
        text = get_progress(1) + "\nğŸ‘¤ <b>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:</b>"
        await callback.message.edit_text(text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="ğŸ”™ Ø§Ù†ØµØ±Ø§Ù", callback_data="main_menu")]]), parse_mode="HTML")

    # 2. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² Ø§Ù‚Ø§Ù…Øª Ø¨Ù‡ Ø³Ù†
    elif current_state == ConsultState.waiting_residence.state:
        await state.set_state(ConsultState.waiting_age)
        text = f"âœ… Ù†Ø§Ù…: <b>{data.get('name')}</b>\n\n" + get_progress(2) + "\nğŸ‚ <b>Ø³Ù† Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</b>"
        await callback.message.edit_text(text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]]), parse_mode="HTML")

    # 3. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ Ø¨Ù‡ Ø§Ù‚Ø§Ù…Øª (Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¯Ú©Ù…Ù‡â€ŒØ§ÛŒ)
    elif current_state == ConsultState.waiting_edu_level.state:
        await state.set_state(ConsultState.waiting_residence)
        text = f"âœ… Ø³Ù†: <b>{data.get('age')}</b>\n\n" + get_progress(3) + "\nğŸŒ <b>Ù…Ø­Ù„ Ø§Ù‚Ø§Ù…Øª ÙØ¹Ù„ÛŒØŸ</b>"
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ‡®ğŸ‡· Ø¯Ø§Ø®Ù„ Ø§ÛŒØ±Ø§Ù†", callback_data="consult_res_iran")],
            [InlineKeyboardButton(text="ğŸ‡®ğŸ‡¹ Ø¯Ø§Ø®Ù„ Ø§ÛŒØªØ§Ù„ÛŒØ§", callback_data="consult_res_italy")],
            [InlineKeyboardButton(text="ğŸ‡ªğŸ‡º Ø§Ø±ÙˆÙ¾Ø§", callback_data="consult_res_eu")],
            [InlineKeyboardButton(text="ğŸŒ Ø³Ø§ÛŒØ±", callback_data="consult_res_other")],
            [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
        ])
        await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")

    # 4. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² Ø³Ø§Ù„ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ Ø¨Ù‡ Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ
    elif current_state == ConsultState.waiting_grad_year.state:
        await state.set_state(ConsultState.waiting_edu_level)
        text = f"âœ… Ø§Ù‚Ø§Ù…Øª: <b>{data.get('residence')}</b>\n\n" + get_progress(4) + "\nğŸ“ <b>Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒØŸ</b>"
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ“˜ Ø¯ÛŒÙ¾Ù„Ù…", callback_data="consult_edu_diploma")],
            [InlineKeyboardButton(text="ğŸ“ Ù„ÛŒØ³Ø§Ù†Ø³", callback_data="consult_edu_bachelor")],
            [InlineKeyboardButton(text="ğŸ“ ÙÙˆÙ‚ Ù„ÛŒØ³Ø§Ù†Ø³", callback_data="consult_edu_master")],
            [InlineKeyboardButton(text="ğŸ“ Ø¯Ú©ØªØ±ÛŒ", callback_data="consult_edu_phd")],
            [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
        ])
        await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")

    # 5. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù† Ø¨Ù‡ Ø³Ø§Ù„ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ
    elif current_state == ConsultState.waiting_lang_cert.state:
        await state.set_state(ConsultState.waiting_grad_year)
        text = f"âœ… Ù…Ø¯Ø±Ú©: <b>{data.get('edu_level')}</b>\n\n" + get_progress(5) + "\nğŸ“… <b>Ø³Ø§Ù„ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ (Ù…ÛŒÙ„Ø§Ø¯ÛŒ)ØŸ</b>"
        await callback.message.edit_text(text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]]), parse_mode="HTML")

    # 6. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² Ø³Ø·Ø­ Ø²Ø¨Ø§Ù† Ø¨Ù‡ Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù†
    elif current_state == ConsultState.waiting_language_level.state:
        await state.set_state(ConsultState.waiting_lang_cert)
        text = f"âœ… Ø³Ø§Ù„ Ù…Ø¯Ø±Ú©: <b>{data.get('grad_year')}</b>\n\n" + get_progress(6) + "\nğŸ“œ <b>Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ</b>"
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="IELTS", callback_data="consult_cert_ielts")],
            [InlineKeyboardButton(text="TOEFL", callback_data="consult_cert_toefl")],
            [InlineKeyboardButton(text="Duolingo", callback_data="consult_cert_duolingo")],
            [InlineKeyboardButton(text="TOLC/CILS", callback_data="consult_cert_italian")],
            [InlineKeyboardButton(text="âŒ Ù†Ø¯Ø§Ø±Ù…", callback_data="consult_cert_none")],
            [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
        ])
        await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")

    # 7. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² Ù‡Ø¯Ù Ø¨Ù‡ Ø³Ø·Ø­ Ø²Ø¨Ø§Ù†
    elif current_state == ConsultState.waiting_goal.state:
        await state.set_state(ConsultState.waiting_language_level)
        text = f"âœ… Ù…Ø¯Ø±Ú© Ø²Ø¨Ø§Ù†: <b>{data.get('lang_cert')}</b>\n\n" + get_progress(7) + "\nğŸ—£ <b>Ø³Ø·Ø­ Ø²Ø¨Ø§Ù†ØŸ</b>"
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="Ù…Ø¨ØªØ¯ÛŒ", callback_data="consult_lvl_beginner")],
            [InlineKeyboardButton(text="Ù…ØªÙˆØ³Ø·", callback_data="consult_lvl_mid")],
            [InlineKeyboardButton(text="Ù¾ÛŒØ´Ø±ÙØªÙ‡", callback_data="consult_lvl_adv")],
            [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
        ])
        await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")

    # 8. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ù‡Ø¯Ù
    elif current_state == ConsultState.waiting_budget.state:
        await state.set_state(ConsultState.waiting_goal)
        text = f"âœ… Ø³Ø·Ø­ Ø²Ø¨Ø§Ù†: <b>{data.get('language_level')}</b>\n\n" + get_progress(8) + "\nğŸ¯ <b>Ù‡Ø¯Ù ØªØ­ØµÛŒÙ„ÛŒØŸ</b>"
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ“ Ù„ÛŒØ³Ø§Ù†Ø³", callback_data="consult_goal_bachelor")],
            [InlineKeyboardButton(text="ğŸ“ ÙÙˆÙ‚ Ù„ÛŒØ³Ø§Ù†Ø³", callback_data="consult_goal_master")],
            [InlineKeyboardButton(text="ğŸ“ Ø¯Ú©ØªØ±ÛŒ", callback_data="consult_goal_phd")],
            [InlineKeyboardButton(text="ğŸ©º Ù¾Ø²Ø´Ú©ÛŒ", callback_data="consult_goal_med")],
            [InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]
        ])
        await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")

    # 9. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡
    elif current_state == ConsultState.waiting_arrival.state:
        await state.set_state(ConsultState.waiting_budget)
        text = f"âœ… Ù‡Ø¯Ù: <b>{data.get('study_goal')}</b>\n\n" + get_progress(9) + "\nğŸ’° <b>Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ (ÛŒÙˆØ±Ùˆ)ØŸ</b>"
        await callback.message.edit_text(text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]]), parse_mode="HTML")

    # 10. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ØªÙ„ÙÙ† Ø¨Ù‡ ÙˆØ±ÙˆØ¯
    elif current_state == ConsultState.waiting_phone.state:
        await state.set_state(ConsultState.waiting_arrival)
        # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù‚Ø¨Ù„ÛŒ (Ø±ÛŒÙ¾Ù„Ø§ÛŒ) Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯
        msg = await callback.message.answer("...", reply_markup=ReplyKeyboardRemove())
        await msg.delete()
        
        text = f"âœ… Ø¨ÙˆØ¯Ø¬Ù‡: <b>{data.get('budget')}</b>\n\n" + get_progress(10) + "\nğŸ“… <b>ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ØŸ</b>"
        await callback.message.answer(text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="ğŸ”™ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„", callback_data="consult_back")]]), parse_mode="HTML")
        await callback.message.delete() # Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø¯Ú©Ù…Ù‡â€ŒØ¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ

    # 11. Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ù‡ ØªÙ„ÙÙ†
    elif current_state == ConsultState.waiting_extra.state:
        await state.set_state(ConsultState.waiting_phone)
        text = f"âœ… ÙˆØ±ÙˆØ¯: <b>{data.get('arrival_date')}</b>\n\n" + get_progress(11) + "\nğŸ“± <b>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ØŸ</b>"
        phone_kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="ğŸ“± Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡", request_contact=True)]], resize_keyboard=True, one_time_keyboard=True)
        await callback.message.answer(text, reply_markup=phone_kb, parse_mode="HTML")
        await callback.message.delete()

    await callback.answer()
